# Deployment Script Design

**Date:** 2026-01-21
**Status:** Approved
**Author:** Claude & Mark

## Overview

A bash script to automate the deployment process documented in `docs/DEPLOYMENT.md`. The script is idempotent, supports checkpoint/resume, and integrates with the existing `generate-env.sh` for credential extraction.

## Goals

1. Automate all deployment steps from DEPLOYMENT.md
2. Make the script idempotent (safe to run multiple times)
3. Support checkpoint/resume so failures don't require starting over
4. Leverage existing `generate-env.sh` for credential extraction
5. Provide clear logging and error messages

## File Structure

```
diego-capacity-analyzer/
├── config/
│   └── deploy.conf.example             # Template config (committed)
├── .state/                             # Hidden, gitignored directory
│   └── deploy-state                    # Checkpoint state (auto-generated)
├── scripts/
│   └── deploy.sh                       # Main deployment script
└── .gitignore                          # Updated to ignore .state/ and config/deploy.conf
```

## CLI Interface

```bash
./scripts/deploy.sh                     # Run all phases
./scripts/deploy.sh --phase=prereqs     # Run only prerequisites check
./scripts/deploy.sh --phase=env         # Run only environment generation
./scripts/deploy.sh --phase=backend     # Run only backend deployment
./scripts/deploy.sh --phase=frontend    # Run only frontend deployment
./scripts/deploy.sh --phase=verify      # Run only verification
./scripts/deploy.sh --skip-prereqs      # Skip prerequisites (phases 2-5)
./scripts/deploy.sh --fresh             # Clear state, run from scratch
./scripts/deploy.sh --verbose           # Show debug output
./scripts/deploy.sh --dry-run           # Show what would be done
./scripts/deploy.sh --help              # Show usage
```

## Phases

### Phase 1: Prerequisites (`phase_prereqs`)

Check that required tools are installed and accessible:

- `cf` CLI exists and version >= 8
- `om` CLI exists
- `node` exists and version >= 18
- `npm` exists
- `jq` exists (needed for JSON parsing)
- Verify CF login (`cf target` succeeds)
- Verify OM connectivity (`om curl /api/v0/info`)

### Phase 2: Environment (`phase_env`)

Generate credentials via existing script:

1. Check if `.env` already exists with required variables
2. If not, call `./generate-env.sh` to generate it
3. Source the `.env` file for subsequent phases

### Phase 3: Backend (`phase_backend`)

Deploy the Go backend service:

1. `cd backend && cf push` (uses manifest.yml)
2. Set sensitive env vars via `cf set-env`:
   - CF_USERNAME, CF_PASSWORD
   - BOSH_CLIENT, BOSH_CLIENT_SECRET, BOSH_CA_CERT
   - BOSH_ENVIRONMENT, BOSH_DEPLOYMENT
3. `cf restage capacity-backend`
4. Wait for app to start
5. Capture BACKEND_URL in state

### Phase 4: Frontend (`phase_frontend`)

Build and deploy the React frontend:

1. Create frontend `.env` with backend URL (`VITE_API_URL`)
2. `npm install`
3. `npm run build`
4. `cf push` (uses manifest.yml, deploys `dist/`)
5. Capture FRONTEND_URL in state

### Phase 5: Verify (`phase_verify`)

Verify the deployment works:

1. Test `/api/v1/health` returns 200
2. Test `/api/v1/dashboard` returns valid JSON
3. Report success/failure summary with URLs

## Configuration

### config/deploy.conf.example

```bash
# Ops Manager credentials (required)
OM_TARGET=opsman.example.com
OM_USERNAME=admin
OM_PASSWORD=

# Optional: Use client credentials instead of username/password
# OM_CLIENT_ID=
# OM_CLIENT_SECRET=

# Optional: For non-routable BOSH networks
# OM_PRIVATE_KEY=~/.ssh/opsman_key

# Optional: Skip SSL validation (not recommended for production)
OM_SKIP_SSL_VALIDATION=false

# CF target org/space for deployment
CF_ORG=system
CF_SPACE=system
```

### Configuration Loading Order

1. Load from `config/deploy.conf` if it exists
2. Fall back to environment variables
3. Use defaults where applicable

## State Management

### State File: `.state/deploy-state`

```bash
# Auto-generated by scripts/deploy.sh - do not edit manually
# Last updated: 2026-01-21T13:45:00-07:00
PHASE_PREREQS=complete
PHASE_ENV=complete
PHASE_BACKEND=complete
PHASE_FRONTEND=pending
PHASE_VERIFY=pending

# Captured values for idempotent operations
BACKEND_URL=capacity-backend.apps.example.com
FRONTEND_URL=capacity-ui.apps.example.com
```

### State Functions

```bash
state_init()           # Create .state/ dir if needed, load existing state
state_get()            # Get value: state_get PHASE_BACKEND → "complete"
state_set()            # Set value: state_set PHASE_BACKEND complete
state_is_complete()    # Check: state_is_complete PHASE_BACKEND → true/false
state_clear()          # Reset all state (used with --fresh flag)
```

### Resume Behavior

- Before each phase, check `state_is_complete PHASE_X`
- If complete, log "Skipping phase X (already complete)" and continue
- If incomplete, run the phase
- On phase success, call `state_set PHASE_X complete`
- On phase failure, script exits (state remains "pending")
- `--fresh` flag calls `state_clear` before running

## Error Handling

### Strict Mode

```bash
#!/usr/bin/env bash
set -Eeuo pipefail
```

### Error Handler

```bash
error_handler() {
    local line=$1
    local command=$2
    log_error "Command failed at line $line: $command"
    log_error "Phase '${CURRENT_PHASE:-unknown}' did not complete"
    log_info "Re-run the script to resume from this phase"
    exit 1
}
trap 'error_handler $LINENO "$BASH_COMMAND"' ERR
```

## Logging

### Log Functions

```bash
log_info()    # [INFO] Blue text, normal operations
log_success() # [OK] Green text, phase completions
log_warn()    # [WARN] Yellow text, non-fatal issues
log_error()   # [ERROR] Red text, failures
log_debug()   # [DEBUG] Only shown with --verbose flag
```

### Example Output

```
[INFO] Starting deployment...
[INFO] Loading config from config/deploy.conf
[INFO] Phase 1: Checking prerequisites
[OK]   cf CLI v8.7.1
[OK]   om CLI v7.8.0
[OK]   node v20.10.0
[OK]   npm v10.2.3
[OK]   jq v1.7
[OK]   CF logged in as admin
[OK]   Phase 1 complete

[INFO] Phase 2: Generating environment
[INFO] Running generate-env.sh...
[OK]   .env generated with credentials
[OK]   Phase 2 complete

[INFO] Phase 3: Deploying backend
[INFO] Pushing capacity-backend...
[INFO] Setting environment variables...
[INFO] Restaging...
[OK]   Backend running at capacity-backend.apps.example.com
[OK]   Phase 3 complete

[INFO] Phase 4: Deploying frontend
[INFO] Installing npm dependencies...
[INFO] Building frontend...
[INFO] Pushing capacity-ui...
[OK]   Frontend running at capacity-ui.apps.example.com
[OK]   Phase 4 complete

[INFO] Phase 5: Verifying deployment
[OK]   /api/v1/health returns 200
[OK]   /api/v1/dashboard returns valid JSON
[OK]   Phase 5 complete

========================================
[OK] Deployment successful!
     Backend:  https://capacity-backend.apps.example.com
     Frontend: https://capacity-ui.apps.example.com
========================================
```

## Dependencies

- `cf` CLI (v8+)
- `om` CLI
- `node` (v18+)
- `npm`
- `jq`
- `bosh` CLI (called by generate-env.sh)

## Integration Points

- Leverages `generate-env.sh` for credential extraction
- Uses existing `backend/manifest.yml` for backend deployment
- Uses existing `frontend/manifest.yml` for frontend deployment
- Follows patterns established in `docs/DEPLOYMENT.md`

## Gitignore Additions

```
.state/
config/deploy.conf
```
